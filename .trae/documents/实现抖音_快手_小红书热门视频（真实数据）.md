## 目标与范围
- 为 `抖音`、`快手`、`小红书` 实现“热门视频”真实数据采集，统一返回格式，避免任何模拟数据回退。
- 仅实现热门数据获取（`GET /api/videos/trending`），暂不改动搜索；后续可按相同架构扩展搜索。
- 前端无破坏性改动，继续使用现有 `videoAPI.getTrendingVideos(platform)` 调用。

## 现有架构对接点
- 路由与聚合：`api/routes/videos.ts:250-270` 调用 `PlatformManager.getTrendingFromAll`
- 管理器：`api/services/platformManager.ts:58-79` 汇总各平台爬虫并做统一排序与裁剪
- B站实现参考：`api/services/platformCrawlers/bilibiliCrawler.ts`（真实接口+格式化）

## 统一数据结构
- 字段规范（与前端 `src/pages/VideoDiscovery.tsx:44-65` 保持兼容）：
  - `id`, `platform`, `title`, `description`, `thumbnail_url`, `video_url`, `duration`
  - `view_count`, `like_count`, `share_count`, `comment_count`, `created_at`
  - `author: { id, name, avatar_url, follower_count, verified }`
  - `tags: string[]`, `category`（映射到已有分类枚举），`relevanceScore`（用于排序），`is_real_data: true`

## 平台差异与实现策略
### 抖音（douyin）
- 数据来源：
  - 优先解析 Web 热榜/推荐页的 SSR 或接口返回（如 `www.douyin.com` 首页/榜单页），通过解析 `script` 中的初始状态 JSON 或公开接口响应。
- 反爬要点：
  - 设定真实 UA、`Accept-Language`，保持 `Referer` 为对应页面。
  - 必要时获取并回传 Cookie（匿名访问即可），不写入敏感信息。
- 字段映射：作品 `aweme_id` → `id`，`desc` → `title/description`，`video.play_addr` → `video_url`，封面 `cover_url` → `thumbnail_url`，`statistics` 映射到计数。
- 分类映射：按 `music/food/tech/...` 标签或分类字段近似映射到现有枚举；默认 `entertainment`。

### 快手（kuaishou）
- 数据来源：
  - 解析 `kuaishou.com` 发现/热门页 SSR 的 JSON（页面中常见 `window.__INITIAL_STATE__` 或 GraphQL 预取数据），或公开 GraphQL 接口（无需鉴权的公共查询）。
- 反爬要点：
  - 真实 UA、`Referer`、必要的 `Accept` 头；若 GraphQL 需携带简单标识，进行最小化伪装。
- 字段映射：`photoId`/`videoId` → `id`，`caption` → `title`，`ext_params.cover` → `thumbnail_url`，`playUrl` → `video_url`，`duration` 与 `likeCount`/`viewCount` 等计数字段对应。
- 分类映射：基于 `tags` 或频道名映射；默认 `entertainment`。

### 小红书（xiaohongshu）
- 数据来源：
  - 解析 `xiaohongshu.com/explore` 热门页的 SSR JSON（`window.__INITIAL_STATE__`），或可访问的公开接口（注意区域与限制）。
- 反爬要点：
  - 设置移动端 UA 更接近真实流量；小红书多图文/短视频并存，需过滤出视频或将图文以视频统一结构兼容（`duration=0`、`video_url` 为空但 `thumbnail_url` 有值）。
- 字段映射：`noteId` → `id`，`title`/`desc` → `title/description`，`images` 首图 → `thumbnail_url`，视频资源 → `video_url`（若无则空），`likedCount`/`collectedCount` 等到计数；作者 `userId/name/avatar` 映射。
- 分类映射：按频道/标签映射；默认 `lifestyle` 更贴近。

## 失败与降级策略
- 若接口响应错误或解析失败：返回空数组，不回退到任何模拟数据。
- 将错误记录在 `logger` 并保留 `PLATFORM_NOT_SUPPORTED` 与 `FETCH_FAILED` 两类明确错误码供前端识别与提示。

## 后端实现步骤
1. 新建爬虫服务文件：
   - `api/services/platformCrawlers/douyinCrawler.ts`
   - `api/services/platformCrawlers/kuaishouCrawler.ts`
   - `api/services/platformCrawlers/xiaohongshuCrawler.ts`
   - 每个实现 `getTrendingVideos(category?, limit?)`，返回统一结构；`searchVideos` 先占位抛错或返回空。
2. 在 `PlatformManager` 注册新平台：`api/services/platformManager.ts:26-48` 增加三者的 `this.crawlers.set(platform, crawler)`。
3. 分类映射：各爬虫内部提供 `mapCategory`；无匹配则回退到默认。
4. 计分与排序：为每条生成 `relevanceScore`（基于播放/点赞/评论），`PlatformManager.getTrendingFromAll` 保持当前合并与裁剪逻辑。
5. 错误处理：捕获网络/解析异常，记录并返回空数组。

## 前端兼容
- 维持现有 `platforms` 列表（已包含三平台）：`src/pages/VideoDiscovery.tsx:100-106`
- 请求路径与参数不变。
- 遇到返回空数组时展示前端 Empty 状态：`src/pages/VideoDiscovery.tsx:671-673`

## 测试与验证
- 本地调试：通过 `GET /api/videos/trending?platform=xxx&limit=20` 分别验证三平台。
- 断言字段完整性与类型：id/标题/链接/封面/计数/时间戳/作者信息。
- 异常场景：网络失败、返回结构变动，确认返回空数组并日志记录。

## 里程碑
- M1：抖音热门（HTML/SSR解析，最小可用）
- M2：快手热门（SSR或公开 GraphQL）
- M3：小红书热门（SSR解析，图文兼容）
- M4：统一分类与计分、前端验证、错误码完善

## 交付物
- 三个平台爬虫实现文件与注册改动
- 无模拟数据回退的真实热门数据返回
- 前端无需改动即可使用，遇到不支持或失败返回空并提示

## 需要确认
- 是否允许使用简单的 HTML 解析方案作为第一阶段（更稳健但可能受反爬限制），后续再迭代更稳固的接口调用方案。
- 是否需要为三平台增加代理/区域适配配置开关（默认关闭）。