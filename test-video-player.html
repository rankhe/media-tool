<!DOCTYPE html>
<html>
<head>
    <title>è§†é¢‘æ’­æ”¾æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .video-card { border: 1px solid #ddd; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .video-title { font-weight: bold; margin-bottom: 5px; }
        .video-info { color: #666; font-size: 14px; }
        .play-button { background: #1890ff; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; }
        .play-button:hover { background: #40a9ff; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
        .modal-content { position: relative; background: white; margin: 50px auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 5px; }
        .close-button { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .close-button:hover { color: #333; }
        video { width: 100%; max-height: 400px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #f6ffed; border: 1px solid #b7eb8f; color: #52c41a; }
        .error { background: #fff2f0; border: 1px solid #ffccc7; color: #ff4d4f; }
    </style>
</head>
<body>
    <h1>ğŸ¬ è§†é¢‘æ’­æ”¾åŠŸèƒ½æµ‹è¯•</h1>
    <div id="status"></div>
    <div id="videos"></div>
    
    <div id="videoModal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeModal()">&times;</button>
            <h3 id="modalTitle">è§†é¢‘æ’­æ”¾</h3>
            <video id="videoPlayer" controls></video>
            <div id="videoInfo"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let token = localStorage.getItem('token');
        
        // æµ‹è¯•å‡½æ•°
        async function testVideoFunctionality() {
            showStatus('æ­£åœ¨æµ‹è¯•è§†é¢‘åŠŸèƒ½...', 'info');
            
            if (!token) {
                showStatus('æœªæ‰¾åˆ°tokenï¼Œæ­£åœ¨å°è¯•ç™»å½•...', 'info');
                await loginAndTest();
            } else {
                await loadVideos();
            }
        }
        
        async function loginAndTest() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@example.com',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    token = data.data.token;
                    localStorage.setItem('token', token);
                    showStatus('ç™»å½•æˆåŠŸï¼æ­£åœ¨åŠ è½½è§†é¢‘...', 'success');
                    await loadVideos();
                } else {
                    showStatus('ç™»å½•å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('ç™»å½•é”™è¯¯: ' + error.message, 'error');
            }
        }
        
        async function loadVideos() {
            try {
                showStatus('æ­£åœ¨ä»Bç«™æ‹‰å–çœŸå®æ•°æ®...', 'info');
                
                const response = await fetch(`${API_BASE}/videos/trending?platform=bilibili&limit=3`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (data.success && data.data.videos) {
                    const videos = data.data.videos;
                    showStatus(`âœ… æˆåŠŸè·å– ${videos.length} ä¸ªè§†é¢‘ï¼Œå…¶ä¸­çœŸå®æ•°æ®: ${videos.filter(v => v.is_real_data).length} ä¸ª`, 'success');
                    displayVideos(videos);
                } else {
                    showStatus('è·å–è§†é¢‘å¤±è´¥: ' + data.message, 'error');
                }
            } catch (error) {
                showStatus('åŠ è½½è§†é¢‘é”™è¯¯: ' + error.message, 'error');
            }
        }
        
        function displayVideos(videos) {
            const container = document.getElementById('videos');
            container.innerHTML = '';
            
            videos.forEach((video, index) => {
                const videoCard = document.createElement('div');
                videoCard.className = 'video-card';
                videoCard.innerHTML = `
                    <div class="video-title">${video.title}</div>
                    <div class="video-info">
                        <strong>å¹³å°:</strong> ${video.platform} | 
                        <strong>ä½œè€…:</strong> ${video.author.name} | 
                        <strong>æ’­æ”¾é‡:</strong> ${formatNumber(video.view_count)} | 
                        <strong>ç‚¹èµ:</strong> ${formatNumber(video.like_count)}
                        ${video.is_real_data ? ' | <span style="color: green;">âœ… çœŸå®æ•°æ®</span>' : ' | <span style="color: orange;">âš ï¸ æ¨¡æ‹Ÿæ•°æ®</span>'}
                    </div>
                    <div class="video-info">
                        <strong>è§†é¢‘é“¾æ¥:</strong> <a href="${video.video_url}" target="_blank">${video.video_url}</a>
                    </div>
                    <div class="video-info">
                        <strong>ç¼©ç•¥å›¾:</strong> <a href="${video.thumbnail_url}" target="_blank">${video.thumbnail_url}</a>
                    </div>
                    <button class="play-button" onclick="playVideo('${video.video_url}', '${video.title.replace(/'/g, "\\'")}', '${video.author.name}')">
                        â–¶ï¸ æ’­æ”¾æµ‹è¯•
                    </button>
                `;
                container.appendChild(videoCard);
            });
        }
        
        function playVideo(videoUrl, title, author) {
            const modal = document.getElementById('videoModal');
            const player = document.getElementById('videoPlayer');
            const modalTitle = document.getElementById('modalTitle');
            const videoInfo = document.getElementById('videoInfo');
            
            modalTitle.textContent = title;
            player.src = videoUrl;
            videoInfo.innerHTML = `
                <p><strong>ä½œè€…:</strong> ${author}</p>
                <p><strong>è§†é¢‘é“¾æ¥:</strong> <a href="${videoUrl}" target="_blank">${videoUrl}</a></p>
                <p style="color: #999; font-size: 12px;">æ³¨æ„: ç”±äºBç«™è§†é¢‘é“¾æ¥éœ€è¦çœŸå®æ’­æ”¾ç¯å¢ƒï¼Œæ­¤æµ‹è¯•ä¸»è¦éªŒè¯å¼¹çª—å…³é—­åŠŸèƒ½</p>
            `;
            
            modal.style.display = 'block';
            
            // å°è¯•æ’­æ”¾è§†é¢‘
            player.play().catch(e => {
                videoInfo.innerHTML += `<p style="color: orange;">âš ï¸ è§†é¢‘æ’­æ”¾å¤±è´¥ (é¢„æœŸè¡Œä¸º): ${e.message}</p>`;
            });
        }
        
        function closeModal() {
            const modal = document.getElementById('videoModal');
            const player = document.getElementById('videoPlayer');
            
            modal.style.display = 'none';
            player.pause();
            player.src = '';
            
            showStatus('âœ… å¼¹çª—å…³é—­æˆåŠŸï¼å…³é—­æŒ‰é’®åŠŸèƒ½æ­£å¸¸', 'success');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'ä¸‡';
            }
            return num.toString();
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('videoModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // ESCé”®å…³é—­
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æµ‹è¯•
        window.onload = function() {
            testVideoFunctionality();
        };
    </script>
</body>
</html>